<!DOCTYPE html>
<html lang="zh-CN">





<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/img/apple-touch-icon.png">
  <link rel="icon" type="image/png" href="/img/favicon.png">
  <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="description" content="Life Is So Short , Just Coding.">
  <meta name="author" content="LoonyCoder">
  <meta name="keywords" content="隐约雷鸣，阴霾天空，但盼风雨来，能留你于此">
  <title>轻量级控制反转和面向切面的容器框架——Spring（六） ~ 望月Plenilune</title>

  <link rel="stylesheet" href="/lib/font-awesome/css/all.min.css"  >
<link rel="stylesheet" href="/lib/bootstrap/css/bootstrap.min.css"  >
<link rel="stylesheet" href="/lib/mdbootstrap/css/mdb.min.css"  >
<link rel="stylesheet" href="/lib/github-markdown/github-markdown.min.css"  >

<link rel="stylesheet" href="//at.alicdn.com/t/font_1067060_qzomjdt8bmp.css">



  <link rel="stylesheet" href="/lib/prettify/tomorrow-night-eighties.min.css"  >

<link rel="stylesheet" href="/css/main.css"  >


  <link rel="stylesheet" href="/lib/fancybox/jquery.fancybox.min.css"  >


<meta name="generator" content="Hexo 4.2.0"></head>


<body>
  <header style="height: 70vh;">
    <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand"
       href="/">&nbsp;<strong>望月Plenilune</strong>&nbsp;</a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
          <li class="nav-item">
            <a class="nav-link" href="/">首页</a>
          </li>
        
          
          
          
          
          <li class="nav-item">
            <a class="nav-link" href="/archives/">归档</a>
          </li>
        
          
          
          
          
          <li class="nav-item">
            <a class="nav-link" href="/categories/">分类</a>
          </li>
        
          
          
          
          
          <li class="nav-item">
            <a class="nav-link" href="/tags/">标签</a>
          </li>
        
          
          
          
          
          <li class="nav-item">
            <a class="nav-link" href="/about/">关于</a>
          </li>
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" data-toggle="modal" data-target="#modalSearch">&nbsp;&nbsp;<i
                class="iconfont icon-search"></i>&nbsp;&nbsp;</a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

    <div class="view intro-2" id="background" false
         style="background: url('/images/post_banner.jpg')no-repeat center center;
           background-size: cover;">
      <div class="full-bg-img">
        <div class="mask rgba-black-light flex-center">
          <div class="container text-center white-text fadeInUp">
            <span class="h2" id="subtitle">
              
            </span>

            
              <br>
              
                <p class="mt-3">
                  <i class="fas fa-calendar-alt" aria-hidden="true"></i>&nbsp;
                  星期日, 九月 1日 2019, 5:22 下午
                </p>
              

              <p>
                
                  
                  &nbsp;<i class="far fa-chart-bar"></i>
                  <span class="post-count">
                    2.8k 字
                  </span>&nbsp;
                

                
                  
                  &nbsp;<i class="far fa-clock"></i>
                  <span class="post-count">
                      13 分钟
                  </span>&nbsp;
                

                
                  <!-- 不蒜子统计文章PV -->
                  
                  &nbsp;<i class="far fa-eye" aria-hidden="true"></i>&nbsp;
                  <span id="busuanzi_container_page_pv">
                    <span id="busuanzi_value_page_pv"></span> 次
                  </span>&nbsp;
                
              </p>
            
          </div>

          
        </div>
      </div>
    </div>
  </header>

  <main>
    
      

<div class="container-fluid">
  <div class="row">
    <div class="d-none d-lg-block col-lg-2"></div>
    <div class="col-lg-8 nopadding-md">
      <div class="py-5 z-depth-3" id="board">
        <div class="post-content mx-auto" id="post">
          <div class="markdown-body">
            <p><img src="/images/spring_logo.jpg" srcset="/img/loading.gif" alt="spring"></p>
<h3 id="写在前面"><a href="#写在前面" class="headerlink" title="写在前面"></a>写在前面</h3><p>之前整理过一些关于Spring框架零散的知识点，一直没时间整理，恰好最近又拜读了<strong>应癫</strong>老师的课程，所以赶紧梳理一下关于Spring的相关知识。</p>
<hr>
<h3 id="Spring-AOP源码深度剖析"><a href="#Spring-AOP源码深度剖析" class="headerlink" title="Spring AOP源码深度剖析"></a>Spring AOP源码深度剖析</h3><h4 id="代理对象创建"><a href="#代理对象创建" class="headerlink" title="代理对象创建"></a>代理对象创建</h4><h5 id="AOP基础用例准备"><a href="#AOP基础用例准备" class="headerlink" title="AOP基础用例准备"></a>AOP基础用例准备</h5><p>Bean定义</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">@Component</span><br><span class="line">public class LagouBean &#123;</span><br><span class="line">	public void <span class="function"><span class="title">tech</span></span>()&#123;</span><br><span class="line">		System.out.println(<span class="string">"java learning......"</span>);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Aspect定义</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">@Component</span><br><span class="line">@Aspect</span><br><span class="line">public class LagouAspect &#123;</span><br><span class="line">	@Pointcut(<span class="string">"execution(* com.lagou.*.*(..))"</span>)</span><br><span class="line">	public void <span class="function"><span class="title">pointcut</span></span>()&#123;</span><br><span class="line">	&#125;</span><br><span class="line">	@Before(<span class="string">"pointcut()"</span>)</span><br><span class="line">	public void <span class="function"><span class="title">before</span></span>() &#123;</span><br><span class="line">		System.out.println(<span class="string">"before method ......"</span>);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>测试⽤例</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line">* 测试⽤例：Aop 代理对象创建</span><br><span class="line">*/</span><br><span class="line">@Test</span><br><span class="line">public void <span class="function"><span class="title">testAopProxyBuild</span></span>()&#123;</span><br><span class="line">	ApplicationContext applicationContext = new AnnotationConfigApplicationContext(SpringConfig.class);</span><br><span class="line">	LagouBean lagouBean = applicationContext.getBean(LagouBean.class);</span><br><span class="line">	lagouBean.tech();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="时机点分析"><a href="#时机点分析" class="headerlink" title="时机点分析"></a>时机点分析</h5><p><img src="/images/spring/s60.png" srcset="/img/loading.gif" alt="spring"></p>
<p>我们发现在 getBean 之前，LagouBean对象已经产⽣（即在第⼀⾏初始化代码中完成），⽽且该对象是⼀个代理对象（Cglib代理对象），我们断定，容器初始化过程中⽬标Ban已经完成了代理，返回了代理对象。</p>
<h5 id="代理对象创建流程"><a href="#代理对象创建流程" class="headerlink" title="代理对象创建流程"></a>代理对象创建流程</h5><p>AbstractAutowireCapableBeanFactory#initializeBean(java.lang.String, java.lang.Object,org.springframework.beans.factory.support.RootBeanDefinition)</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line">*</span><br><span class="line">* 初始化Bean</span><br><span class="line">包括Bean后置处理器初始化</span><br><span class="line">Bean的⼀些初始化⽅法的执⾏init-method</span><br><span class="line">Bean的实现的声明周期相关接⼝的属性注⼊</span><br><span class="line">*/</span><br><span class="line">protected Object initializeBean(final String beanName, final Object bean,</span><br><span class="line">@Nullable RootBeanDefinition mbd) &#123;</span><br><span class="line">	// 执⾏所有的AwareMethods</span><br><span class="line">	<span class="keyword">if</span> (System.getSecurityManager() != null) &#123;</span><br><span class="line">		AccessController.doPrivileged((PrivilegedAction&lt;Object&gt;) () -&gt; &#123;</span><br><span class="line">			invokeAwareMethods(beanName, bean);</span><br><span class="line">			<span class="built_in">return</span> null;</span><br><span class="line">		&#125;, getAccessControlContext());</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span> &#123;</span><br><span class="line">	ifnvokeAwareMethods(beanName, bean);</span><br><span class="line">	&#125;</span><br><span class="line">	Object wrappedBean = bean;</span><br><span class="line">	<span class="keyword">if</span> (mbd == null || !mbd.isSynthetic()) &#123;</span><br><span class="line">		// 执⾏所有的BeanPostProcessor<span class="comment">#postProcessBeforeInitialization 初始化之前的处理器⽅法</span></span><br><span class="line">		wrappedBean = applyBeanPostProcessorsBeforeInitialization(wrappedBean,beanName);</span><br><span class="line">	&#125;</span><br><span class="line">	try &#123;</span><br><span class="line">		// 这⾥就开始执⾏afterPropertiesSet（实现了InitializingBean接⼝）⽅法和 initMethod</span><br><span class="line">		invokeInitMethods(beanName, wrappedBean, mbd);</span><br><span class="line">	&#125;</span><br><span class="line">	catch (Throwable ex) &#123;</span><br><span class="line">		throw new BeanCreationException((mbd != null ? mbd.getResourceDescription() : null),beanName, <span class="string">"Invocation of init method failed"</span>, ex);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> (mbd == null || !mbd.isSynthetic()) &#123;</span><br><span class="line">		// 整个Bean初始化完成，执⾏后置处理器⽅法</span><br><span class="line">		wrappedBean = applyBeanPostProcessorsAfterInitialization(wrappedBean,beanName);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="built_in">return</span> wrappedBean; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>AbstractAutowireCapableBeanFactory#applyBeanPostProcessorsAfterInitialization</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">public Object applyBeanPostProcessorsAfterInitialization(Object existingBean, String beanName) throws BeansException &#123;</span><br><span class="line">	Object result = existingBean;</span><br><span class="line">	// 循环执⾏后置处理器</span><br><span class="line">	<span class="keyword">for</span> (BeanPostProcessor processor : getBeanPostProcessors()) &#123;</span><br><span class="line">		Object current = processor.postProcessAfterInitialization(result,</span><br><span class="line">		beanName);</span><br><span class="line">		<span class="keyword">if</span> (current == null) &#123;</span><br><span class="line">			<span class="built_in">return</span> result; </span><br><span class="line">		&#125;</span><br><span class="line">		result = current; </span><br><span class="line">	&#125;</span><br><span class="line">	<span class="built_in">return</span> result; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/images/spring/s61.png" srcset="/img/loading.gif" alt="spring"></p>
<p>创建代理对象的后置处理器AbstractAutoProxyCreator#postProcessAfterInitialization</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line">* Create a proxy with the configured interceptors <span class="keyword">if</span> the bean is</span><br><span class="line">* identified as one to proxy by the subclass.</span><br><span class="line">* @see <span class="comment">#getAdvicesAndAdvisorsForBean</span></span><br><span class="line">*/</span><br><span class="line">@Override</span><br><span class="line">public Object postProcessAfterInitialization(@Nullable Object bean, String beanName) &#123;</span><br><span class="line">	<span class="keyword">if</span> (bean != null) &#123;</span><br><span class="line">	// 检查下该类是否已经暴露过了（可能已经创建了，⽐如A依赖B时，创建A时候，就会先去创建B。</span><br><span class="line">	// 当真正需要创建B时，就没必要再代理⼀次已经代理过的对象）,避免重复创建</span><br><span class="line">	Object cacheKey = getCacheKey(bean.getClass(), beanName);</span><br><span class="line">		<span class="keyword">if</span> (this.earlyProxyReferences.remove(cacheKey) != bean) &#123;</span><br><span class="line">			<span class="built_in">return</span> wrapIfNecessary(bean, beanName, cacheKey);</span><br><span class="line">		&#125; </span><br><span class="line">	&#125;</span><br><span class="line">	<span class="built_in">return</span> bean; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>AbstractAutoProxyCreator#wrapIfNecessary</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line">* Wrap the given bean <span class="keyword">if</span> necessary, i.e. <span class="keyword">if</span> it is eligible <span class="keyword">for</span> being</span><br><span class="line">proxied.</span><br><span class="line">* @param bean the raw bean instance</span><br><span class="line">* @param beanName the name of the bean</span><br><span class="line">* @param cacheKey the cache key <span class="keyword">for</span> metadata access</span><br><span class="line">* @<span class="built_in">return</span> a proxy wrapping the bean, or the raw bean instance as-is</span><br><span class="line">*/</span><br><span class="line">protected Object wrapIfNecessary(Object bean, String beanName, Object cacheKey) &#123;</span><br><span class="line">	// targetSourcedBeans包含，说明前⾯创建过</span><br><span class="line">	<span class="keyword">if</span> (StringUtils.hasLength(beanName) &amp;&amp; this.targetSourcedBeans.contains(beanName)) &#123;</span><br><span class="line">		<span class="built_in">return</span> bean; </span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> (Boolean.FALSE.equals(this.advisedBeans.get(cacheKey))) &#123;</span><br><span class="line">		<span class="built_in">return</span> bean; </span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> (isInfrastructureClass(bean.getClass()) || shouldSkip(bean.getClass(), beanName)) &#123;</span><br><span class="line">		this.advisedBeans.put(cacheKey, Boolean.FALSE);</span><br><span class="line">		<span class="built_in">return</span> bean; </span><br><span class="line">	&#125;</span><br><span class="line">	// Create proxy <span class="keyword">if</span> we have advice.</span><br><span class="line">	// 得到所有候选Advisor，对Advisors和bean的⽅法双层遍历匹配，最终得到⼀个 List&lt;Advisor&gt;，即specificInterceptors</span><br><span class="line">	Object[] specificInterceptors = getAdvicesAndAdvisorsForBean(bean.getClass(), beanName, null);</span><br><span class="line">	<span class="keyword">if</span> (specificInterceptors != DO_NOT_PROXY) &#123;</span><br><span class="line">		this.advisedBeans.put(cacheKey, Boolean.TRUE);</span><br><span class="line">		// 重点，创建代理对象</span><br><span class="line">		Object proxy = createProxy(bean.getClass(), beanName, specificInterceptors, new SingletonTargetSource(bean));</span><br><span class="line">		this.proxyTypes.put(cacheKey, proxy.getClass());</span><br><span class="line">		<span class="built_in">return</span> proxy; </span><br><span class="line">	&#125;</span><br><span class="line">	this.advisedBeans.put(cacheKey, Boolean.FALSE);</span><br><span class="line">	<span class="built_in">return</span> bean; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>AbstractAutoProxyCreator#createProxy</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line">* Create an AOP proxy <span class="keyword">for</span> the given bean.</span><br><span class="line">* 为指定 bean 创建代理对象</span><br><span class="line">*/</span><br><span class="line">protected Object createProxy(Class&lt;?&gt; beanClass, @Nullable String beanName, @Nullable Object[] specificInterceptors, TargetSource targetSource) &#123;</span><br><span class="line">	<span class="keyword">if</span> (this.beanFactory instanceof ConfigurableListableBeanFactory) &#123;</span><br><span class="line">		AutoProxyUtils.exposeTargetClass((ConfigurableListableBeanFactory)</span><br><span class="line">		this.beanFactory, beanName, beanClass);</span><br><span class="line">	&#125;</span><br><span class="line">	// 创建代理的⼯作交给ProxyFactory</span><br><span class="line">	ProxyFactory proxyFactory = new ProxyFactory();</span><br><span class="line">	proxyFactory.copyFrom(this);</span><br><span class="line">	// 根据⼀些情况判断是否要设置proxyTargetClass=<span class="literal">true</span></span><br><span class="line">	<span class="keyword">if</span> (!proxyFactory.isProxyTargetClass()) &#123;</span><br><span class="line">		<span class="keyword">if</span> (shouldProxyTargetClass(beanClass, beanName)) &#123;</span><br><span class="line">			proxyFactory.setProxyTargetClass(<span class="literal">true</span>);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span> &#123;</span><br><span class="line">		evaluateProxyInterfaces(beanClass, proxyFactory);</span><br><span class="line">		&#125; </span><br><span class="line">	&#125;</span><br><span class="line">	// 把指定和通⽤拦截对象合并, 并都适配成Advisor</span><br><span class="line">	Advisor[] advisors = buildAdvisors(beanName, specificInterceptors);</span><br><span class="line">	proxyFactory.addAdvisors(advisors);</span><br><span class="line">	// 设置参数</span><br><span class="line">	proxyFactory.setTargetSource(targetSource);</span><br><span class="line">	customizeProxyFactory(proxyFactory);</span><br><span class="line">	proxyFactory.setFrozen(this.freezeProxy);</span><br><span class="line">	<span class="keyword">if</span> (advisorsPreFiltered()) &#123;</span><br><span class="line">	proxyFactory.setPreFiltered(<span class="literal">true</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	// 上⾯准备做完就开始创建代理</span><br><span class="line">	<span class="built_in">return</span> proxyFactory.getProxy(getProxyClassLoader());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>接着跟进到ProxyFactory中</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">public class ProxyFactory extends ProxyCreatorSupport &#123;</span><br><span class="line">	public Object getProxy(ClassLoader classLoader) &#123;</span><br><span class="line">		// ⽤ProxyFactory创建AopProxy, 然后⽤AopProxy创建Proxy, 所以这⾥重要的是看获取的AopProxy对象是什么,</span><br><span class="line">		// 然后进去看怎么创建动态代理, 提供了两种：jdk proxy, cglib</span><br><span class="line">		<span class="built_in">return</span> createAopProxy().getProxy(classLoader);</span><br><span class="line">	&#125; </span><br><span class="line">&#125;</span><br><span class="line">public class ProxyCreatorSupport extends AdvisedSupport &#123;</span><br><span class="line">	private AopProxyFactory aopProxyFactory;</span><br><span class="line">	public <span class="function"><span class="title">ProxyCreatorSupport</span></span>() &#123;</span><br><span class="line">		this.aopProxyFactory = new DefaultAopProxyFactory();</span><br><span class="line">	&#125;</span><br><span class="line">	protected final synchronized AopProxy <span class="function"><span class="title">createAopProxy</span></span>() &#123;</span><br><span class="line">		<span class="keyword">if</span> (!this.active) &#123;</span><br><span class="line">			activate();</span><br><span class="line">		&#125;</span><br><span class="line">		//先获取创建AopProxy的⼯⼚, 再由此创建AopProxy</span><br><span class="line">		<span class="built_in">return</span> getAopProxyFactory().createAopProxy(this);</span><br><span class="line">	&#125;</span><br><span class="line">	public AopProxyFactory <span class="function"><span class="title">getAopProxyFactory</span></span>() &#123;</span><br><span class="line">		<span class="built_in">return</span> this.aopProxyFactory; </span><br><span class="line">	&#125; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>流程就是⽤AopProxyFactory创建AopProxy, 再⽤AopProxy创建代理对象，这⾥的AopProxyFactory默认是DefaultAopProxyFactory，看它的<code>createAopProxy</code>⽅法</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">public class DefaultAopProxyFactory implements AopProxyFactory, Serializable &#123;</span><br><span class="line">	@Override</span><br><span class="line">	public AopProxy createAopProxy(AdvisedSupport config) throws AopConfigException &#123;</span><br><span class="line">		<span class="keyword">if</span> (config.isOptimize() || config.isProxyTargetClass() || hasNoUserSuppliedProxyInterfaces(config)) &#123;</span><br><span class="line">			Class&lt;?&gt; targetClass = config.getTargetClass();</span><br><span class="line">			<span class="keyword">if</span> (targetClass == null) &#123;</span><br><span class="line">				throw new AopConfigException(<span class="string">"TargetSource cannot determine target class: "</span> + <span class="string">"Either an interface or a target is required for proxy creation."</span>);</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">if</span> (targetClass.isInterface()) &#123;</span><br><span class="line">				<span class="built_in">return</span> new JdkDynamicAopProxy(config);</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="built_in">return</span> new ObjenesisCglibAopProxy(config);</span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			<span class="built_in">return</span> new JdkDynamicAopProxy(config);</span><br><span class="line">		&#125; </span><br><span class="line">	&#125;</span><br><span class="line">	/**</span><br><span class="line">	* Determine whether the supplied &#123;@link AdvisedSupport&#125; has only the</span><br><span class="line">	* &#123;@link org.springframework.aop.SpringProxy&#125; interface specified (or no</span><br><span class="line">	* proxy interfaces specified at all).</span><br><span class="line">	*/</span><br><span class="line">	private boolean hasNoUserSuppliedProxyInterfaces(AdvisedSupport config) &#123;</span><br><span class="line">		Class&lt;?&gt;[] interfaces = config.getProxiedInterfaces();</span><br><span class="line">		<span class="built_in">return</span> (interfaces.length == 0 || (interfaces.length == 1 &amp;&amp; SpringProxy.class.equals(interfaces[0])));</span><br><span class="line">	&#125; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这⾥决定创建代理对象是⽤JDK Proxy，还是⽤ Cglib 了，最简单的从使⽤⽅⾯使⽤来说：设置proxyTargetClass=true强制使⽤Cglib 代理，什么参数都不设并且对象类实现了接⼝则默认⽤JDK代理，如果没有实现接⼝则也必须⽤Cglib<br>ProxyFactory#getProxy(java.lang.ClassLoader)<br>CglibAopProxy#getProxy(java.lang.ClassLoader)</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">public Object getProxy(@Nullable ClassLoader classLoader) &#123;</span><br><span class="line">	<span class="keyword">if</span> (logger.isTraceEnabled()) &#123;</span><br><span class="line">		logger.trace(<span class="string">"Creating CGLIB proxy: "</span> + this.advised.getTargetSource());</span><br><span class="line">	&#125;</span><br><span class="line">	try &#123;</span><br><span class="line">		Class&lt;?&gt; rootClass = this.advised.getTargetClass();</span><br><span class="line">		Assert.state(rootClass != null, <span class="string">"Target class must be available for creating a CGLIB proxy"</span>);</span><br><span class="line">		Class&lt;?&gt; proxySuperClass = rootClass;</span><br><span class="line">		<span class="keyword">if</span> (ClassUtils.isCglibProxyClass(rootClass)) &#123;</span><br><span class="line">			proxySuperClass = rootClass.getSuperclass();</span><br><span class="line">			Class&lt;?&gt;[] additionalInterfaces = rootClass.getInterfaces();</span><br><span class="line">			<span class="keyword">for</span> (Class&lt;?&gt; additionalInterface : additionalInterfaces) &#123;</span><br><span class="line">				this.advised.addInterface(additionalInterface);</span><br><span class="line">			&#125; </span><br><span class="line">		&#125;</span><br><span class="line">		// Validate the class, writing <span class="built_in">log</span> messages as necessary.</span><br><span class="line">		validateClassIfNecessary(proxySuperClass, classLoader);</span><br><span class="line">		// 配置 Cglib 增强</span><br><span class="line">		Enhancer enhancer = createEnhancer();</span><br><span class="line">		<span class="keyword">if</span> (classLoader != null) &#123;</span><br><span class="line">			enhancer.setClassLoader(classLoader);</span><br><span class="line">			<span class="keyword">if</span> (classLoader instanceof SmartClassLoader &amp;&amp; ((SmartClassLoader) classLoader).isClassReloadable(proxySuperClass)) &#123;</span><br><span class="line">				enhancer.setUseCache(<span class="literal">false</span>);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		enhancer.setSuperclass(proxySuperClass);</span><br><span class="line">		enhancer.setInterfaces(AopProxyUtils.completeProxiedInterfaces(this.advised));</span><br><span class="line">		enhancer.setNamingPolicy(SpringNamingPolicy.INSTANCE);</span><br><span class="line">		enhancer.setStrategy(new</span><br><span class="line">		ClassLoaderAwareUndeclaredThrowableStrategy(classLoader));</span><br><span class="line">		Callback[] callbacks = getCallbacks(rootClass);</span><br><span class="line">		Class&lt;?&gt;[] types = new Class&lt;?&gt;[callbacks.length];</span><br><span class="line">		<span class="keyword">for</span> (int x = 0; x &lt; types.length; x++) &#123;</span><br><span class="line">			types[x] = callbacks[x].getClass();</span><br><span class="line">		&#125;</span><br><span class="line">		// fixedInterceptorMap only populated at this point, after getCallbacks call above</span><br><span class="line">		enhancer.setCallbackFilter(new ProxyCallbackFilter(this.advised.getConfigurationOnlyCopy(), this.fixedInterceptorMap,this.fixedInterceptorOffset));</span><br><span class="line">		enhancer.setCallbackTypes(types);</span><br><span class="line">		// ⽣成代理类，并且创建⼀个代理类的实例</span><br><span class="line">		<span class="built_in">return</span> createProxyClassAndInstance(enhancer, callbacks);</span><br><span class="line">	&#125;catch (CodeGenerationException | IllegalArgumentException ex) &#123;</span><br><span class="line">		throw new AopConfigException(<span class="string">"Could not generate CGLIB subclass of "</span> + this.advised.getTargetClass() +<span class="string">": Common causes of this problem include using a final class or anon-visible class"</span>,ex);</span><br><span class="line">	&#125;catch (Throwable ex) &#123;</span><br><span class="line">		// TargetSource.getTarget() failed</span><br><span class="line">		throw new AopConfigException(<span class="string">"Unexpected AOP exception"</span>, ex);</span><br><span class="line">	&#125; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>AOP源码分析类⽅法调⽤关系记录</strong></p>
<blockquote>
<p>org.springframework.beans.factory.support.AbstractAutowireCapableBeanFactory#initializeBean<br><strong>调⽤</strong><br>org.springframework.beans.factory.support.AbstractAutowireCapableBeanFactory#applyBeanPostProcessorsAfterInitialization<br><strong>调⽤</strong><br>org.springframework.aop.framework.autoproxy.AbstractAutoProxyCreator#postProcessAfterInitialization（后置处理器AbstractAutoProxyCreator完成bean代理对象创建）<br><strong>调⽤</strong><br>org.springframework.aop.framework.autoproxy.AbstractAutoProxyCreator#wrapIfNecessary<br><strong>调⽤</strong><br>org.springframework.aop.framework.autoproxy.AbstractAutoProxyCreator#createProxy （在这⼀步把委托对象的aop增强和通⽤拦截进⾏合并，最终给代理对象）<br><strong>调⽤</strong><br>org.springframework.aop.framework.DefaultAopProxyFactory#createAopProxy<br><strong>调⽤</strong><br>org.springframework.aop.framework.CglibAopProxy#getProxy(java.lang.ClassLoader)</p>
</blockquote>
<h4 id="Spring声明式事务控制"><a href="#Spring声明式事务控制" class="headerlink" title="Spring声明式事务控制"></a>Spring声明式事务控制</h4><p>声明式事务很⽅便，尤其纯注解模式，仅仅⼏个注解就能控制事务了<br>思考：这些注解都做了什么？好神奇！<br>@EnableTransactionManagement @Transactional</p>
<h5 id="EnableTransactionManagement"><a href="#EnableTransactionManagement" class="headerlink" title="@EnableTransactionManagement"></a>@EnableTransactionManagement</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">@Target(ElementType.TYPE)</span><br><span class="line">@Retention(RetentionPolicy.RUNTIME)</span><br><span class="line">@Documented</span><br><span class="line">@Import(TransactionManagementConfigurationSelector.class)</span><br><span class="line">public @interface EnableTransactionManagement &#123;...&#125;</span><br></pre></td></tr></table></figure>

<p><code>@EnableTransactionManagement</code> 注解使⽤ <code>@Import</code> 标签引⼊了TransactionManagementConfigurationSelector类，这个类⼜向容器中导⼊了两个重要的组件</p>
<p><img src="/images/spring/s62.png" srcset="/img/loading.gif" alt="spring"></p>
<h5 id="加载事务控制组件"><a href="#加载事务控制组件" class="headerlink" title="加载事务控制组件"></a>加载事务控制组件</h5><ul>
<li>AutoProxyRegistrar<br>AutoProxyRegistrar 类的 registerBeanDefinitions ⽅法中⼜注册了⼀个组件</li>
</ul>
<p><img src="/images/spring/s63.png" srcset="/img/loading.gif" alt="spring"></p>
<p>进⼊ AopConfigUtils.registerAutoProxyCreatorIfNecessary ⽅法</p>
<p><img src="/images/spring/s64.png" srcset="/img/loading.gif" alt="spring"></p>
<p>发现最终，注册了⼀个叫做 InfrastructureAdvisorAutoProxyCreator 的 Bean，⽽这个类是AbstractAutoProxyCreator 的⼦类，实现了 SmartInstantiationAwareBeanPostProcessor 接⼝</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">public class InfrastructureAdvisorAutoProxyCreator extends AbstractAdvisorAutoProxyCreator</span><br><span class="line">public abstract class AbstractAdvisorAutoProxyCreator extends AbstractAutoProxyCreator</span><br><span class="line">public abstract class AbstractAutoProxyCreator extends ProxyProcessorSupport implements SmartInstantiationAwareBeanPostProcessor, BeanFactoryAware</span><br></pre></td></tr></table></figure>

<p>继承体系结构图如下</p>
<p><img src="/images/spring/s65.png" srcset="/img/loading.gif" alt="spring"></p>
<p>它实现了SmartInstantiationAwareBeanPostProcessor，说明这是⼀个后置处理器，⽽且跟Spring AOP 开启@EnableAspectJAutoProxy 时注册的 AnnotationAwareAspectJProxyCreator实现的是同⼀个接⼝，所以说，声明式事务是 SpringAOP 思想的⼀种应⽤。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line">/*</span><br><span class="line">* Copyright 2002-2017 the original author or authors.</span><br><span class="line">*</span><br><span class="line">* Licensed under the Apache License, Version 2.0 (the <span class="string">"License"</span>);</span><br><span class="line">* you may not use this file except <span class="keyword">in</span> compliance with the License.</span><br><span class="line">* You may obtain a copy of the License at</span><br><span class="line">*</span><br><span class="line">* https://www.apache.org/licenses/LICENSE-2.0</span><br><span class="line">*</span><br><span class="line">* Unless required by applicable law or agreed to <span class="keyword">in</span> writing, software</span><br><span class="line">* distributed under the License is distributed on an <span class="string">"AS IS"</span> BASIS,</span><br><span class="line">* WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span><br><span class="line">* See the License <span class="keyword">for</span> the specific language governing permissions and</span><br><span class="line">* limitations under the License.</span><br><span class="line">*/</span><br><span class="line">package org.springframework.transaction.annotation;</span><br><span class="line">import org.springframework.beans.factory.config.BeanDefinition;</span><br><span class="line">import org.springframework.context.annotation.Bean;</span><br><span class="line">import org.springframework.context.annotation.Configuration;</span><br><span class="line">import org.springframework.context.annotation.Role;</span><br><span class="line">import org.springframework.transaction.config.TransactionManagementConfigUtils;</span><br><span class="line">import org.springframework.transaction.interceptor.BeanFactoryTransactionAttributeSourceAdvisor;</span><br><span class="line">import org.springframework.transaction.interceptor.TransactionAttributeSource;</span><br><span class="line">import org.springframework.transaction.interceptor.TransactionInterceptor;</span><br><span class="line">/**</span><br><span class="line">* &#123;@code @Configuration&#125; class that registers the Spring infrastructure beans</span><br><span class="line">* necessary to <span class="built_in">enable</span> proxy-based annotation-driven transaction management.</span><br><span class="line">*</span><br><span class="line">* @author Chris Beams</span><br><span class="line">* @since 3.1</span><br><span class="line">* @see EnableTransactionManagement</span><br><span class="line">* @see TransactionManagementConfigurationSelector</span><br><span class="line">*/</span><br><span class="line">@Configuration</span><br><span class="line">public class ProxyTransactionManagementConfiguration extends AbstractTransactionManagementConfiguration &#123;</span><br><span class="line">	@Bean(name = TransactionManagementConfigUtils.TRANSACTION_ADVISOR_BEAN_NAME)</span><br><span class="line">	@Role(BeanDefinition.ROLE_INFRASTRUCTURE)</span><br><span class="line">		public BeanFactoryTransactionAttributeSourceAdvisor <span class="function"><span class="title">transactionAdvisor</span></span>()&#123;</span><br><span class="line">		// 事务增强器</span><br><span class="line">		BeanFactoryTransactionAttributeSourceAdvisor advisor = new BeanFactoryTransactionAttributeSourceAdvisor();</span><br><span class="line">		// 向事务增强器中注⼊ 属性解析器 transactionAttributeSource</span><br><span class="line">		advisor.setTransactionAttributeSource(transactionAttributeSource());</span><br><span class="line">		// 向事务增强器中注⼊ 事务拦截器 transactionInterceptor</span><br><span class="line">		advisor.setAdvice(transactionInterceptor());</span><br><span class="line">		<span class="keyword">if</span> (this.enableTx != null) &#123;</span><br><span class="line">			advisor.setOrder(this.enableTx.&lt;Integer&gt;getNumber(<span class="string">"order"</span>));</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="built_in">return</span> advisor; </span><br><span class="line">	&#125;</span><br><span class="line">	@Bean</span><br><span class="line">	@Role(BeanDefinition.ROLE_INFRASTRUCTURE)</span><br><span class="line">	// 属性解析器 transactionAttributeSource</span><br><span class="line">	public TransactionAttributeSource <span class="function"><span class="title">transactionAttributeSource</span></span>() &#123;</span><br><span class="line">		<span class="built_in">return</span> new AnnotationTransactionAttributeSource();</span><br><span class="line">	&#125;</span><br><span class="line">	@Bean</span><br><span class="line">	@Role(BeanDefinition.ROLE_INFRASTRUCTURE)</span><br><span class="line">	// 事务拦截器 transactionInterceptor</span><br><span class="line">	public TransactionInterceptor <span class="function"><span class="title">transactionInterceptor</span></span>() &#123;</span><br><span class="line">		TransactionInterceptor interceptor = new TransactionInterceptor();</span><br><span class="line">		interceptor.setTransactionAttributeSource(transactionAttributeSource());</span><br><span class="line">		<span class="keyword">if</span> (this.txManager != null) &#123;</span><br><span class="line">			interceptor.setTransactionManager(this.txManager);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="built_in">return</span> interceptor; </span><br><span class="line">	&#125; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ProxyTransactionManagementConfiguration是⼀个容器配置类，注册了⼀个组件transactionAdvisor，称为事务增强器，然后在这个事务增强器中⼜注⼊了两个属性：<br>transactionAttributeSource，即属性解析器transactionAttributeSource 和<br>事务拦截器transactionInterceptor</p>
<ul>
<li><p>属性解析器 AnnotationTransactionAttributeSource 部分源码如下<br><img src="/images/spring/s66.png" srcset="/img/loading.gif" alt="spring"><br>属性解析器有⼀个成员变量是annotationParsers，是⼀个集合，可以添加多种注解解析器<br>(TransactionAnnotationParser)，我们关注 Spring 的注解解析器，部分源码如下<br><img src="/images/spring/s67.png" srcset="/img/loading.gif" alt="spring"><br>属性解析器的作⽤之⼀就是⽤来解析<code>@Transaction</code>注解</p>
</li>
<li><p>TransactionInterceptor 事务拦截器，部分源码如下<br><img src="/images/spring/s68.png" srcset="/img/loading.gif" alt="spring"><br><img src="/images/spring/s69.png" srcset="/img/loading.gif" alt="spring"></p>
</li>
<li><p>上述组件如何关联起来的？</p>
<ul>
<li>事务拦截器实现了MethodInterceptor接⼝，追溯⼀下上⾯提到的InfrastructureAdvisorAutoProxyCreator后置处理器，它会在代理对象执⾏⽬标⽅法的时候获取其拦截器链，⽽拦截器链就是这个TransactionInterceptor，这就把这两个组件联系起来；</li>
<li>构造⽅法传⼊PlatformTransactionManager(事务管理器)、TransactionAttributeSource(属性解析器)，但是追溯⼀下上⾯贴的ProxyTransactionManagementConfiguration的源码，在注册事务拦截器的时候并没有调⽤这个带参构造⽅法，⽽是调⽤的⽆参构造⽅法，然后再调⽤set⽅法注⼊这两个属性，效果⼀样。</li>
</ul>
</li>
<li><p>invokeWithinTransaction ⽅法，部分源码如下（关注1、2、3、4 标注处）<br><img src="/images/spring/s70.png" srcset="/img/loading.gif" alt="spring"><br><img src="/images/spring/s71.png" srcset="/img/loading.gif" alt="spring"></p>
</li>
</ul>
<p><strong>声明式事务分析过程记录</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">@EnableTransactionManagement 注解</span><br><span class="line">1)通过@Import引⼊了TransactionManagementConfigurationSelector类</span><br><span class="line">它的selectImports⽅法导⼊了另外两个类：AutoProxyRegistrar和ProxyTransactionManagementConfiguration</span><br><span class="line"></span><br><span class="line">2)AutoProxyRegistrar类分析</span><br><span class="line">⽅法registerBeanDefinitions中，引⼊了其他类，通过AopConfigUtils.registerAutoProxyCreatorIfNecessary(registry)引⼊InfrastructureAdvisorAutoProxyCreator，它继承了AbstractAutoProxyCreator，是⼀个后置处理器类</span><br><span class="line"></span><br><span class="line">3)ProxyTransactionManagementConfiguration是⼀个添加了@Configuration注解的配置类（注册bean）</span><br><span class="line">注册事务增强器（注⼊属性解析器、事务拦截器）</span><br><span class="line">	属性解析器：AnnotationTransactionAttributeSource，内部持有了⼀个解析器集合Set&lt;TransactionAnnotationParser&gt; annotationParsers;</span><br><span class="line">	具体使⽤的是SpringTransactionAnnotationParser解析器，⽤来解析@Transactional的事务属性</span><br><span class="line">	事务拦截器：TransactionInterceptor实现了MethodInterceptor接⼝，该通⽤拦截会在产⽣代理对象之前和aop增强合并，最终⼀起影响到代理对象TransactionInterceptor的invoke⽅法中invokeWithinTransaction会触发原有业务逻辑调⽤（增强事务）</span><br></pre></td></tr></table></figure>

            <hr>
          </div>
          <br>
          <div>
            <p>
            
              <span>
                <i class="iconfont icon-inbox"></i>
                
                  <a class="hover-with-bg" href="/categories/Java%E6%A1%86%E6%9E%B6">Java框架</a>
                  &nbsp;
                
              </span>&nbsp;&nbsp;
            
            
              <span>
                <i class="iconfont icon-tag"></i>
                
                  <a class="hover-with-bg" href="/tags/Spring%E5%85%A8%E5%AE%B6%E6%A1%B6">Spring全家桶</a>
                
                  <a class="hover-with-bg" href="/tags/IoC">IoC</a>
                
                  <a class="hover-with-bg" href="/tags/AOP">AOP</a>
                
              </span>
            
            </p>
            
              <p class="note note-warning">本博客所有文章除特别声明外，均采用 <a href="https://zh.wikipedia.org/wiki/Wikipedia:CC_BY-SA_3.0%E5%8D%8F%E8%AE%AE%E6%96%87%E6%9C%AC" target="_blank" rel="nofollow noopener noopener">CC BY-SA 3.0协议</a> 。转载请注明出处！</p>
            
          </div>
        </div>
      </div>
    </div>
    <div class="d-none d-lg-block col-lg-2 toc-container">
      
  <div id="toc">
    <p class="h5"><i class="far fa-list-alt"></i>&nbsp;目录</p>
    <div id="tocbot"></div>
  </div>

    </div>
  </div>
</div>

<!-- custom -->


<!-- Comments -->
<div class="col-lg-7 mx-auto nopadding-md">
  <div class="container comments mx-auto" id="comments">
    
      <br><br>
      
      

    
  </div>
</div>

    
  </main>

  
    <a class="z-depth-1" id="scroll-top-button" href="#" role="button">
      <i class="fa fa-chevron-up scroll-top-arrow" aria-hidden="true"></i>
    </a>
  

  
    <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v"
                 for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>
  

  <footer class="mt-5">
  <div class="text-center py-3">
    <a href="https://github.com/Loonycoder" target="_blank" rel="nofollow noopener"><b>望月</b></a>
    <i class="iconfont icon-love"></i>
    <a href="https://github.com/Loonycoder" target="_blank" rel="nofollow noopener"> <b>LoonyCoder</b></a>
    <br>

    
  
    <!-- 不蒜子统计PV -->
    
    &nbsp;<span id="busuanzi_container_site_pv"></span>访问量: 
          <span id="busuanzi_value_site_pv"></span> &nbsp;
  
  
    <!-- 不蒜子统计UV -->
    
    &nbsp;<span id="busuanzi_container_site_uv"></span>访客数: 
            <span id="busuanzi_value_site_uv"></span> &nbsp;
  
  <br>



    
  <!-- 备案信息 -->
  <a href="http://beian.miit.gov.cn/" target="_blank"
     rel="nofollow noopener">京ICP证20008174号</a>
  
    <a
      href="http://www.beian.gov.cn/portal/registerSystemInfo?recordcode=20008174"
      rel="nofollow noopener"
      class="police-beian"
      target="_blank"
    >
      <span class="police-beian-sep">&nbsp;|&nbsp;</span>
      
        <img src="/img/police_beian.png" />
      
      <span>京公网安备20008174号</span>
    </a>
  



    <!-- cnzz Analytics icon -->
    

  </div>
</footer>

<!-- SCRIPTS -->
<script src="/lib/jquery/jquery.min.js" ></script>
<script src="/lib/popper/popper.min.js" ></script>
<script src="/lib/bootstrap/js/bootstrap.min.js" ></script>
<script src="/lib/mdbootstrap/js/mdb.min.js" ></script>
<script src="/js/main.js" ></script>


  <script src="/js/lazyload.js" ></script>



  <script src="/js/post.js" ></script>
  
    <script src="/lib/tocbot/tocbot.min.js" ></script>
    <script>
      $(document).ready(function () {
        tocbot.init({
          tocSelector: '#tocbot',
          contentSelector: '.post-content',
          headingSelector: 'h1,h2,h3,h4,h5,h6',
          linkClass: 'tocbot-link',
          activeLinkClass: 'tocbot-active-link',
          listClass: 'tocbot-list',
          isCollapsedClass: 'tocbot-is-collapsed',
          collapsibleClass: 'tocbot-is-collapsible',
          scrollSmooth: true,
        });
      });
    </script>
  



  <script src="/lib/smoothscroll/SmoothScroll.min.js" ></script>



  <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" ></script>


<!-- Plugins -->


  

  

  

  

  <!-- cnzz Analytics -->
  



  <script src="/lib/prettify/prettify.min.js" ></script>
  <script>
    $(document).ready(function () {
      $('pre').addClass('prettyprint  linenums');
      prettyPrint();
    })
  </script>



  <script src="/lib/typed/typed.min.js" ></script>
  <script>
    var typed = new Typed('#subtitle', {
      strings: [
        '  ',
        "轻量级控制反转和面向切面的容器框架——Spring（六）&nbsp;",
      ],
      cursorChar: "_",
      typeSpeed: 70,
      loop: false,
    });
    typed.stop();
    $(document).ready(function () {
      $(".typed-cursor").addClass("h2");
      typed.start();
    });
  </script>



  <script src="/lib/anchor/anchor.min.js" ></script>
  <script>
    anchors.options = {
      placement: "right",
      visible: "hover",
      
      icon: "❡"
      
    };
    var el = "h1,h2,h3,h4,h5,h6".split(",");
    var res = [];
    for (item of el) {
      res.push(".markdown-body > " + item)
    }
    anchors.add(res.join(", "))
  </script>



  <script src="/js/local-search.js" ></script>
  <script>
    var path = "/local-search.xml";
    var inputArea = document.querySelector("#local-search-input");
    inputArea.onclick = function () {
      getSearchFile(path);
      this.onclick = null
    }
  </script>



  <script src="/lib/fancybox/jquery.fancybox.min.js" ></script>
  <script>
    $("#post img:not(.no-zoom img, img[no-zoom])").each(
      function () {
        var element = document.createElement("a");
        $(element).attr("data-fancybox", "images");
        $(element).attr("href", $(this).attr("src"));
        $(this).wrap(element);
      }
    );
  </script>





  
  
    <script>
      !function (e, t, a) {
        function r() {
          for (var e = 0; e < s.length; e++) s[e].alpha <= 0 ? (t.body.removeChild(s[e].el), s.splice(e, 1)) : (s[e].y--, s[e].scale += .004, s[e].alpha -= .013, s[e].el.style.cssText = "left:" + s[e].x + "px;top:" + s[e].y + "px;opacity:" + s[e].alpha + ";transform:scale(" + s[e].scale + "," + s[e].scale + ") rotate(45deg);background:" + s[e].color + ";z-index:99999");
          requestAnimationFrame(r)
        }

        function n() {
          var t = "function" == typeof e.onclick && e.onclick;
          e.onclick = function (e) {
            t && t(), o(e)
          }
        }

        function o(e) {
          var a = t.createElement("div");
          a.className = "heart", s.push({
            el: a,
            x: e.clientX - 5,
            y: e.clientY - 5,
            scale: 1,
            alpha: 1,
            color: c()
          }), t.body.appendChild(a)
        }

        function i(e) {
          var a = t.createElement("style");
          a.type = "text/css";
          try {
            a.appendChild(t.createTextNode(e))
          } catch (t) {
            a.styleSheet.cssText = e
          }
          t.getElementsByTagName("head")[0].appendChild(a)
        }

        function c() {
          return "rgb(" + ~~(255 * Math.random()) + "," + ~~(255 * Math.random()) + "," + ~~(255 * Math.random()) + ")"
        }

        var s = [];
        e.requestAnimationFrame = e.requestAnimationFrame || e.webkitRequestAnimationFrame || e.mozRequestAnimationFrame || e.oRequestAnimationFrame || e.msRequestAnimationFrame || function (e) {
          setTimeout(e, 1e3 / 60)
        }, i(".heart{width: 10px;height: 10px;position: fixed;background: #f00;transform: rotate(45deg);-webkit-transform: rotate(45deg);-moz-transform: rotate(45deg);}.heart:after,.heart:before{content: '';width: inherit;height: inherit;background: inherit;border-radius: 50%;-webkit-border-radius: 50%;-moz-border-radius: 50%;position: fixed;}.heart:after{top: -5px;}.heart:before{left: -5px;}"), n(), r()
      }(window, document);
    </script>
  








</body>
</html>
