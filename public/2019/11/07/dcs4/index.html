<!DOCTYPE html>
<html lang="zh-CN">





<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/img/apple-touch-icon.png">
  <link rel="icon" type="image/png" href="/img/favicon.png">
  <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="description" content="Life Is So Short , Just Coding.">
  <meta name="author" content="LoonyCoder">
  <meta name="keywords" content="隐约雷鸣，阴霾天空，但盼风雨来，能留你于此">
  <title>分布式集群架构场景化解决方案——分布式调度问题 ~ 望月Plenilune</title>

  <link rel="stylesheet" href="/lib/font-awesome/css/all.min.css"  >
<link rel="stylesheet" href="/lib/bootstrap/css/bootstrap.min.css"  >
<link rel="stylesheet" href="/lib/mdbootstrap/css/mdb.min.css"  >
<link rel="stylesheet" href="/lib/github-markdown/github-markdown.min.css"  >

<link rel="stylesheet" href="//at.alicdn.com/t/font_1067060_qzomjdt8bmp.css">



  <link rel="stylesheet" href="/lib/prettify/tomorrow-night-eighties.min.css"  >

<link rel="stylesheet" href="/css/main.css"  >


  <link rel="stylesheet" href="/lib/fancybox/jquery.fancybox.min.css"  >


<meta name="generator" content="Hexo 4.2.0"></head>


<body>
  <header style="height: 70vh;">
    <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand"
       href="/">&nbsp;<strong>望月Plenilune</strong>&nbsp;</a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
          <li class="nav-item">
            <a class="nav-link" href="/">首页</a>
          </li>
        
          
          
          
          
          <li class="nav-item">
            <a class="nav-link" href="/archives/">归档</a>
          </li>
        
          
          
          
          
          <li class="nav-item">
            <a class="nav-link" href="/categories/">分类</a>
          </li>
        
          
          
          
          
          <li class="nav-item">
            <a class="nav-link" href="/tags/">标签</a>
          </li>
        
          
          
          
          
          <li class="nav-item">
            <a class="nav-link" href="/about/">关于</a>
          </li>
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" data-toggle="modal" data-target="#modalSearch">&nbsp;&nbsp;<i
                class="iconfont icon-search"></i>&nbsp;&nbsp;</a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

    <div class="view intro-2" id="background" false
         style="background: url('/images/post_banner.jpg')no-repeat center center;
           background-size: cover;">
      <div class="full-bg-img">
        <div class="mask rgba-black-light flex-center">
          <div class="container text-center white-text fadeInUp">
            <span class="h2" id="subtitle">
              
            </span>

            
              <br>
              
                <p class="mt-3">
                  <i class="fas fa-calendar-alt" aria-hidden="true"></i>&nbsp;
                  星期四, 十一月 7日 2019, 6:29 晚上
                </p>
              

              <p>
                
                  
                  &nbsp;<i class="far fa-chart-bar"></i>
                  <span class="post-count">
                    3.4k 字
                  </span>&nbsp;
                

                
                  
                  &nbsp;<i class="far fa-clock"></i>
                  <span class="post-count">
                      14 分钟
                  </span>&nbsp;
                

                
                  <!-- 不蒜子统计文章PV -->
                  
                  &nbsp;<i class="far fa-eye" aria-hidden="true"></i>&nbsp;
                  <span id="busuanzi_container_page_pv">
                    <span id="busuanzi_value_page_pv"></span> 次
                  </span>&nbsp;
                
              </p>
            
          </div>

          
        </div>
      </div>
    </div>
  </header>

  <main>
    
      

<div class="container-fluid">
  <div class="row">
    <div class="d-none d-lg-block col-lg-2"></div>
    <div class="col-lg-8 nopadding-md">
      <div class="py-5 z-depth-3" id="board">
        <div class="post-content mx-auto" id="post">
          <div class="markdown-body">
            <h3 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h3><p>调度 —&gt; 定时任务，分布式调度 —&gt; 在分布式集群环境下定时任务这件事。<br>Elastic-job（当当⽹开源的分布式调度框架）</p>
<h4 id="定时任务的场景"><a href="#定时任务的场景" class="headerlink" title="定时任务的场景"></a>定时任务的场景</h4><p>定时任务形式：每隔⼀定时间/特定某⼀时刻执⾏。</p>
<p>例如：</p>
<ul>
<li>订单审核、出库</li>
<li>订单超时⾃动取消、⽀付退款</li>
<li>礼券同步、⽣成、发放作业</li>
<li>物流信息推送、抓取作业、退换货处理作业</li>
<li>数据积压监控、⽇志监控、服务可⽤性探测作业</li>
<li>定时备份数据</li>
<li>⾦融系统每天的定时结算</li>
<li>数据归档、清理作业</li>
<li>报表、离线数据分析作业</li>
</ul>
<h4 id="什么是分布式调度"><a href="#什么是分布式调度" class="headerlink" title="什么是分布式调度"></a>什么是分布式调度</h4><p>什么是分布式任务调度？有两层含义</p>
<ul>
<li>运⾏在分布式集群环境下的调度任务（同⼀个定时任务程序部署多份，只应该有⼀个定时任务在执⾏）</li>
<li>分布式调度 —&gt; 定时任务的分布式—&gt;定时任务的拆分（即为把⼀个⼤的作业任务拆分为多个⼩的作业任务，同时执⾏）</li>
</ul>
<p><img src="/images/dcs/dcs22.png" srcset="/img/loading.gif" alt="dcs"></p>
<h4 id="定时任务与消息队列的区别"><a href="#定时任务与消息队列的区别" class="headerlink" title="定时任务与消息队列的区别"></a>定时任务与消息队列的区别</h4><ul>
<li><p>共同点</p>
<ul>
<li>异步处理<br>⽐如注册、下单事件</li>
<li>应⽤解耦<br>不管定时任务作业还是MQ都可以作为两个应⽤之间的⻮轮实现应⽤解耦，这个⻮轮可以中转数据，当然单体服务不需要考虑这些，服务拆分的时候往往都会考虑。</li>
<li>流量削峰<br>双⼗⼀的时候，任务作业和MQ都可以⽤来扛流量，后端系统根据服务能⼒定时处理订单或者从MQ抓取订单抓取到⼀个订单到来事件的话触发处理，对于前端⽤户来说看到的结果是已经下单成功了，下单是不受任何影响的。</li>
</ul>
</li>
<li><p>本质不同</p>
<ul>
<li>定时任务作业是时间驱动，⽽MQ是事件驱动；</li>
<li>时间驱动是不可代替的，⽐如⾦融系统每⽇的利息结算，不是说利息来⼀条（利息到来事件）就算⼀下，⽽往往是通过定时任务批量计算；所以，定时任务作业更倾向于批处理，MQ倾向于逐条处理；</li>
</ul>
</li>
</ul>
<h4 id="定时任务的实现⽅式"><a href="#定时任务的实现⽅式" class="headerlink" title="定时任务的实现⽅式"></a>定时任务的实现⽅式</h4><p>定时任务的实现⽅式有多种。早期没有定时任务框架的时候，我们会使⽤JDK中的Timer机制和多线程机制（Runnable+线程休眠）来实现定时或者间隔⼀段时间执⾏某⼀段程序；后来有了定时任务框架，⽐如⼤名鼎鼎的Quartz任务调度框架，使⽤时间表达式（包括：秒、分、时、⽇、周、年）配置某⼀个任务什么时间去执⾏：</p>
<ul>
<li><p><strong>任务调度框架Quartz回顾示意</strong></p>
<ul>
<li><p>引⼊jar</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&lt;!--任务调度框架quartz--&gt;</span><br><span class="line">&lt;!-- https://mvnrepository.com/artifact/org.quartz-scheduler/quartz --&gt;</span><br><span class="line">&lt;dependency&gt; </span><br><span class="line">	&lt;groupId&gt;org.quartz-scheduler&lt;/groupId&gt;</span><br><span class="line">	&lt;artifactId&gt;quartz&lt;/artifactId&gt;</span><br><span class="line">	&lt;version&gt;2.3.2&lt;/version&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br></pre></td></tr></table></figure></li>
<li><p>定时任务作业主调度程序</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line">	package quartz;</span><br><span class="line">	import org.quartz.*;</span><br><span class="line">	import org.quartz.impl.StdSchedulerFactory;</span><br><span class="line">	public class QuartzMain &#123;</span><br><span class="line">		// 创建作业任务调度器（类似于公交调度站）</span><br><span class="line">		public static Scheduler createScheduler() throws SchedulerException &#123;</span><br><span class="line">		SchedulerFactory schedulerFactory = new StdSchedulerFactory();</span><br><span class="line">		Scheduler scheduler = schedulerFactory.getScheduler();</span><br><span class="line">		<span class="built_in">return</span> scheduler;</span><br><span class="line">	 &#125;</span><br><span class="line">	// 创建⼀个作业任务（类似于⼀辆公交⻋）</span><br><span class="line">	public static JobDetail <span class="function"><span class="title">createJob</span></span>() &#123;</span><br><span class="line">		JobBuilder jobBuilder = JobBuilder.newJob(DemoJob.class);</span><br><span class="line">		jobBuilder.withIdentity(<span class="string">"jobName"</span>,<span class="string">"myJob"</span>);</span><br><span class="line">		JobDetail jobDetail = jobBuilder.build();</span><br><span class="line">		<span class="built_in">return</span> jobDetail;</span><br><span class="line">	 &#125;</span><br><span class="line">	/**</span><br><span class="line">	* 创建作业任务时间触发器（类似于公交⻋出⻋时间表）</span><br><span class="line">	* cron表达式由七个位置组成，空格分隔</span><br><span class="line">	* 1、Seconds（秒） 0~59</span><br><span class="line">	* 2、Minutes（分） 0~59</span><br><span class="line">	* 3、Hours（⼩时） 0~23</span><br><span class="line">	* 4、Day of Month（天）1~31,注意有的⽉份不⾜31天</span><br><span class="line">	* 5、Month（⽉） 0~11,或者</span><br><span class="line">	JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC</span><br><span class="line">	* 6、Day of Week(周) 1~7,1=SUN或者 SUN,MON,TUE,WEB,THU,FRI,SAT</span><br><span class="line">	* 7、Year（年）1970~2099 可选项</span><br><span class="line">	*示例：</span><br><span class="line">	* 0 0 11 * * ? 每天的11点触发执⾏⼀次</span><br><span class="line">	* 0 30 10 1 * ? 每⽉1号上午10点半触发执⾏⼀次</span><br><span class="line">	*/</span><br><span class="line">	public static Trigger <span class="function"><span class="title">createTrigger</span></span>() &#123;</span><br><span class="line">		// 创建时间触发器，按⽇历调度</span><br><span class="line">		CronTrigger trigger = TriggerBuilder.newTrigger().withIdentity(<span class="string">"triggerName"</span>,<span class="string">"myTrigger"</span>).startNow().withSchedule(CronScheduleBuilder.cronSchedule(<span class="string">"0/2 * * * * ?"</span>)).build();</span><br><span class="line">		// 创建触发器，按简单间隔调度</span><br><span class="line">		/*SimpleTrigger trigger1 = TriggerBuilder.newTrigger()</span><br><span class="line">		.withIdentity(<span class="string">"triggerName"</span>,<span class="string">"myTrigger"</span>)</span><br><span class="line">		.startNow()</span><br><span class="line">		.withSchedule(SimpleScheduleBuilder</span><br><span class="line">		.simpleSchedule()</span><br><span class="line">		.withIntervalInSeconds(3)</span><br><span class="line">		.repeatForever())</span><br><span class="line">		.build();*/</span><br><span class="line">		<span class="built_in">return</span> trigger;</span><br><span class="line">	 &#125;</span><br><span class="line">	// 定时任务作业主调度程序</span><br><span class="line">	public static void main(String[] args) throws SchedulerException &#123;</span><br><span class="line">		// 创建⼀个作业任务调度器（类似于公交调度站）</span><br><span class="line">		Scheduler scheduler = QuartzMain.createScheduler();</span><br><span class="line">		// 创建⼀个作业任务（类似于⼀辆公交⻋）</span><br><span class="line">		JobDetail job = QuartzMain.createJob();</span><br><span class="line">		// 创建⼀个作业任务时间触发器（类似于公交⻋出⻋时间表）</span><br><span class="line">		Trigger trigger = QuartzMain.createTrigger();</span><br><span class="line">		// 使⽤调度器按照时间触发器执⾏这个作业任务</span><br><span class="line">		scheduler.scheduleJob(job,trigger);</span><br><span class="line">		scheduler.start();</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>定义⼀个job，需实现Job接⼝</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">package quartz;</span><br><span class="line">import org.quartz.Job;</span><br><span class="line">import org.quartz.JobExecutionContext;</span><br><span class="line">import org.quartz.JobExecutionException;</span><br><span class="line">public class DemoJob implements Job &#123;</span><br><span class="line">	public void execute(JobExecutionContext jobExecutionContext) throws JobExecutionException &#123;</span><br><span class="line">		System.out.println(<span class="string">"我是⼀个定时任务逻辑"</span>);</span><br><span class="line">		&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

</li>
</ul>
</li>
</ul>
<p>以上，是回顾⼀下任务调度框架Quartz的⼤致⽤法，那么在分布式架构环境中使⽤Quartz已经不能更好的满⾜我们需求，我们可以使⽤专业的分布式调度框架，这⾥我们推荐使⽤Elastic-job。</p>
<h4 id="分布式调度框架Elastic-Job"><a href="#分布式调度框架Elastic-Job" class="headerlink" title="分布式调度框架Elastic-Job"></a>分布式调度框架Elastic-Job</h4><h5 id="Elastic-Job介绍"><a href="#Elastic-Job介绍" class="headerlink" title="Elastic-Job介绍"></a>Elastic-Job介绍</h5><p>Elastic-Job是当当⽹开源的⼀个分布式调度解决⽅案，基于Quartz⼆次开发的，由两个相互独⽴的⼦项⽬Elastic-Job-Lite和Elastic-Job-Cloud组成。我们要学习的是Elastic-Job-Lite，它定位为轻量级⽆中⼼化解决⽅案，使⽤Jar包的形式提供分布式任务的协调服务，⽽Elastic-Job-Cloud⼦项⽬需要结合Mesos以及Docker在云环境下使⽤。<br>Elastic-Job的github地址：<a href="https://github.com/elasticjob" target="_blank" rel="noopener">https://github.com/elasticjob</a></p>
<p><strong>主要功能介绍</strong></p>
<ul>
<li><strong>分布式调度协调</strong>:在分布式环境中，任务能够按指定的调度策略执⾏，并且能够避免同⼀任务多实例重复执⾏</li>
<li><strong>丰富的调度策略</strong>:基于成熟的定时任务作业框架Quartz cron表达式执⾏定时任务</li>
<li><strong>弹性扩容缩容</strong>:当集群中增加某⼀个实例，它应当也能够被选举并执⾏任务；当集群减少⼀个实例<br>时，它所执⾏的任务能被转移到别的实例来执⾏。</li>
<li><strong>失效转移</strong>:某实例在任务执⾏失败后，会被转移到其他实例执⾏</li>
<li><strong>错过执⾏作业重触发</strong>:若因某种原因导致作业错过执⾏，⾃动记录错过执⾏的作业，并在上次作业完成后⾃动触发。</li>
<li><strong>⽀持并⾏调度</strong>:⽀持任务分⽚，任务分⽚是指将⼀个任务分为多个⼩任务项在多个实例同时执⾏。</li>
<li><strong>作业分⽚⼀致性</strong>:当任务被分⽚后，保证同⼀分⽚在分布式环境中仅⼀个执⾏实例。</li>
</ul>
<h5 id="Elastic-Job-Lite应⽤"><a href="#Elastic-Job-Lite应⽤" class="headerlink" title="Elastic-Job-Lite应⽤"></a>Elastic-Job-Lite应⽤</h5><p>Elastic-Job依赖于Zookeeper进⾏分布式协调，所以需要安装Zookeeper软件（3.4.6版本以上），关于Zookeeper，此处我们不做详解，在阶段三会有深度学习，我们此处需要明⽩Zookeeper的本质功能：存储+通知。</p>
<ul>
<li>安装Zookeeper（此处单例配置）</li>
</ul>
<ol>
<li>我们使⽤3.4.10版本，在linux平台解压下载的zookeeper-3.4.10.tar.gz</li>
<li>进⼊conf⽬录，cp zoo_sample.cfg zoo.cfg</li>
<li>进⼊bin⽬录，启动zk服务<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">启动 ./zkServer.sh start</span><br><span class="line">停⽌ ./zkServer.sh stop</span><br><span class="line">查看状态 ./zkServer.sh status</span><br></pre></td></tr></table></figure>

</li>
</ol>
<p><img src="/images/dcs/dcs23.png" srcset="/img/loading.gif" alt="dcs"></p>
<ul>
<li>引⼊Jar包</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&lt;!-- https://mvnrepository.com/artifact/com.dangdang/elastic-job-lite-core--&gt;</span><br><span class="line">&lt;dependency&gt; </span><br><span class="line">	&lt;groupId&gt;com.dangdang&lt;/groupId&gt; </span><br><span class="line">	&lt;artifactId&gt;elastic-job-lite-core&lt;/artifactId&gt; </span><br><span class="line">	&lt;version&gt;2.1.5&lt;/version&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br></pre></td></tr></table></figure>

<ul>
<li><p>定时任务实例</p>
<ul>
<li>需求：每隔两秒钟执⾏⼀次定时任务（resume表中未归档的数据归档到resume_bak表中，每次归档1条记录）</li>
</ul>
<ol>
<li>resume_bak和resume表结构完全⼀样</li>
<li>resume表中数据归档之后不删除，只将state置为”已归档”</li>
</ol>
<ul>
<li><p>数据表结构</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">-- ----------------------------</span><br><span class="line">-- Table structure <span class="keyword">for</span> resume</span><br><span class="line">-- ----------------------------</span><br><span class="line">DROP TABLE IF EXISTS `resume`;</span><br><span class="line">CREATE TABLE `resume` (</span><br><span class="line"> `id` bigint(20) NOT NULL AUTO_INCREMENT,</span><br><span class="line"> `name` varchar(255) DEFAULT NULL,</span><br><span class="line"> `sex` varchar(255) DEFAULT NULL,</span><br><span class="line"> `phone` varchar(255) DEFAULT NULL,</span><br><span class="line"> `address` varchar(255) DEFAULT NULL,</span><br><span class="line"> `education` varchar(255) DEFAULT NULL,</span><br><span class="line"> `state` varchar(255) DEFAULT NULL,</span><br><span class="line"> PRIMARY KEY (`id`)</span><br><span class="line">) ENGINE=InnoDB AUTO_INCREMENT=1001 DEFAULT CHARSET=utf8;</span><br><span class="line">SET FOREIGN_KEY_CHECKS = 1;</span><br></pre></td></tr></table></figure></li>
<li><p>程序开发</p>
<ul>
<li><p>定时任务类</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">package elasticjob;</span><br><span class="line">import com.dangdang.ddframe.job.api.ShardingContext;</span><br><span class="line">import com.dangdang.ddframe.job.api.simple.SimpleJob;</span><br><span class="line">import util.JdbcUtil;</span><br><span class="line">import java.sql.Connection;</span><br><span class="line">import java.sql.PreparedStatement;</span><br><span class="line">import java.sql.ResultSet;</span><br><span class="line">import java.util.List;</span><br><span class="line">import java.util.Map;</span><br><span class="line">public class BackupJob implements SimpleJob &#123;</span><br><span class="line">	// 定时任务每执⾏⼀次都会执⾏如下的逻辑</span><br><span class="line">	@Override</span><br><span class="line">	public void execute(ShardingContext shardingContext) &#123;</span><br><span class="line">		/*</span><br><span class="line">		从resume数据表查找1条未归档的数据，将其归档到resume_bak</span><br><span class="line">		表，并更新状态为已归档（不删除原数据）</span><br><span class="line">		*/</span><br><span class="line">		// 查询出⼀条数据</span><br><span class="line">		String selectSql = <span class="string">"select * from resume where</span></span><br><span class="line"><span class="string">		state='未归档' limit 1"</span>;</span><br><span class="line">		List&lt;Map&lt;String, Object&gt;&gt; list =</span><br><span class="line">		JdbcUtil.executeQuery(selectSql);</span><br><span class="line">		<span class="keyword">if</span>(list == null || list.size() == 0) &#123;</span><br><span class="line">			<span class="built_in">return</span>;</span><br><span class="line">			&#125;</span><br><span class="line">		Map&lt;String, Object&gt; stringObjectMap = list.get(0);</span><br><span class="line">		long id = (long) stringObjectMap.get(<span class="string">"id"</span>);</span><br><span class="line">		String name = (String) stringObjectMap.get(<span class="string">"name"</span>);</span><br><span class="line">		String education = (String)</span><br><span class="line">		stringObjectMap.get(<span class="string">"education"</span>);</span><br><span class="line">		// 打印出这条记录</span><br><span class="line">		System.out.println(<span class="string">"======&gt;&gt;&gt;id："</span> + id + <span class="string">" name："</span> +</span><br><span class="line">		name + <span class="string">" education："</span> + education);</span><br><span class="line">		// 更改状态</span><br><span class="line">		String updateSql = <span class="string">"update resume set state='已归档'</span></span><br><span class="line"><span class="string">		where id=?"</span>;</span><br><span class="line">		JdbcUtil.executeUpdate(updateSql,id);</span><br><span class="line">		// 归档这条记录</span><br><span class="line">		String insertSql = <span class="string">"insert into resume_bak select *</span></span><br><span class="line"><span class="string">		from resume where id=?"</span>;</span><br><span class="line">		JdbcUtil.executeUpdate(insertSql,id);</span><br><span class="line">		&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li><p>主类</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">package elasticjob;</span><br><span class="line">import com.dangdang.ddframe.job.config.JobCoreConfiguration;</span><br><span class="line">import com.dangdang.ddframe.job.config.simple.SimpleJobConfiguration;</span><br><span class="line">import com.dangdang.ddframe.job.lite.api.JobScheduler;</span><br><span class="line">import com.dangdang.ddframe.job.lite.config.LiteJobConfiguration;</span><br><span class="line">import com.dangdang.ddframe.job.reg.base.CoordinatorRegistryCenter;</span><br><span class="line">import com.dangdang.ddframe.job.reg.zookeeper.ZookeeperConfiguration;</span><br><span class="line">import com.dangdang.ddframe.job.reg.zookeeper.ZookeeperRegistryCenter;</span><br><span class="line">public class ElasticJobMain &#123;</span><br><span class="line">	public static void main(String[] args) &#123;</span><br><span class="line">		// 配置注册中⼼zookeeper，zookeeper协调调度，不能让任务重复执⾏，</span><br><span class="line">		通过命名空间分类管理任务，对应到zookeeper的⽬录</span><br><span class="line">		ZookeeperConfiguration zookeeperConfiguration = newZookeeperConfiguration(<span class="string">"localhost:2181"</span>,<span class="string">"data-archive-job"</span>);</span><br><span class="line">		CoordinatorRegistryCenter coordinatorRegistryCenter = new ZookeeperRegistryCenter(zookeeperConfiguration);</span><br><span class="line">		coordinatorRegistryCenter.init();</span><br><span class="line">		// 配置任务</span><br><span class="line">		JobCoreConfiguration jobCoreConfiguration = JobCoreConfiguration.newBuilder(<span class="string">"archive-job"</span>,<span class="string">"*/2 * * * * ?"</span>,1).build();</span><br><span class="line">		SimpleJobConfiguration simpleJobConfiguration = new SimpleJobConfiguration(jobCoreConfiguration,BackupJob.class.getName());</span><br><span class="line">		// 启动任务</span><br><span class="line">		new JobScheduler(coordinatorRegistryCenter,LiteJobConfiguration.newBuilder(simpleJobConfiguration).build()).init();</span><br><span class="line">	 &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li><p>JdbcUtil⼯具类</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br></pre></td><td class="code"><pre><span class="line">package util;</span><br><span class="line">import java.sql.*;</span><br><span class="line">import java.util.ArrayList;</span><br><span class="line">import java.util.HashMap;</span><br><span class="line">import java.util.List;</span><br><span class="line">import java.util.Map;</span><br><span class="line">public class JdbcUtil &#123;</span><br><span class="line">			//url</span><br><span class="line">			private static String url = <span class="string">"jdbc:mysql://localhost:3306/job?</span></span><br><span class="line"><span class="string">			characterEncoding=utf8&amp;useSSL=false"</span>;</span><br><span class="line">			//user</span><br><span class="line">			private static String user = <span class="string">"root"</span>;</span><br><span class="line">			//password</span><br><span class="line">			private static String password = <span class="string">"123456"</span>;</span><br><span class="line">			//驱动程序类</span><br><span class="line">			private static String driver = <span class="string">"com.mysql.jdbc.Driver"</span>;</span><br><span class="line">			static &#123;</span><br><span class="line">				try &#123;</span><br><span class="line">					Class.forName(driver);</span><br><span class="line">				&#125; catch (ClassNotFoundException e) &#123;</span><br><span class="line">					// TODO Auto-generated catch block</span><br><span class="line">					e.printStackTrace();</span><br><span class="line">				 &#125;</span><br><span class="line">			&#125;</span><br><span class="line">			public static Connection <span class="function"><span class="title">getConnection</span></span>() &#123;</span><br><span class="line">				try &#123;</span><br><span class="line">				&lt;rp&gt;&lt;/rp&gt;eturn DriverManager.getConnection(url, user,password);</span><br><span class="line">				&#125; catch (SQLException e) &#123;</span><br><span class="line">					// TODO Auto-generated catch block</span><br><span class="line">					e.printStackTrace();</span><br><span class="line"> 				&#125;</span><br><span class="line">				<span class="built_in">return</span> null;</span><br><span class="line"> 			&#125;</span><br><span class="line">			public static void close(ResultSet rs, PreparedStatement ps,</span><br><span class="line">				Connection con) &#123;</span><br><span class="line">				<span class="keyword">if</span> (rs != null) &#123;</span><br><span class="line">					try &#123;</span><br><span class="line">						rs.close();</span><br><span class="line">				 	&#125; catch (SQLException e) &#123;</span><br><span class="line">					// TODO Auto-generated catch block</span><br><span class="line">						e.printStackTrace();</span><br><span class="line">				 	&#125; finally &#123;</span><br><span class="line">						<span class="keyword">if</span> (ps != null) &#123;</span><br><span class="line">							try &#123;</span><br><span class="line">								ps.close();</span><br><span class="line">				 			&#125; catch (SQLException e) &#123;</span><br><span class="line">							// TODO Auto-generated catch block</span><br><span class="line">								e.printStackTrace();</span><br><span class="line">				 			&#125; finally &#123;</span><br><span class="line">								<span class="keyword">if</span> (con != null) &#123;</span><br><span class="line">									try &#123;</span><br><span class="line">										con.close();</span><br><span class="line">				 					&#125; catch (SQLException e) &#123;</span><br><span class="line">									// TODO Auto-generated catch block</span><br><span class="line">									e.printStackTrace();</span><br><span class="line"> 								&#125;</span><br><span class="line"> 							&#125;</span><br><span class="line"> 					&#125;</span><br><span class="line"> 				&#125;</span><br><span class="line"> 			&#125;</span><br><span class="line"> 		&#125;</span><br><span class="line"> &#125;</span><br><span class="line"> public static void executeUpdate(String sql,Object...obj) &#123;</span><br><span class="line">	Connection con = getConnection();</span><br><span class="line">	PreparedStatement ps = null;</span><br><span class="line">	try &#123;</span><br><span class="line">		ps = con.prepareStatement(sql);</span><br><span class="line">		<span class="keyword">for</span> (int i = 0; i &lt; obj.length; i++) &#123;</span><br><span class="line">			ps.setObject(i + 1, obj[i]);</span><br><span class="line">		 &#125;</span><br><span class="line">		ps.executeUpdate();</span><br><span class="line">	 &#125; catch (SQLException e) &#123;</span><br><span class="line">		// TODO Auto-generated catch block</span><br><span class="line">		e.printStackTrace();</span><br><span class="line">	 &#125; finally &#123;</span><br><span class="line">		close(null, ps, con);</span><br><span class="line">	 &#125;</span><br><span class="line">&#125;</span><br><span class="line">	public static List&lt;Map&lt;String,Object&gt;&gt; executeQuery(String sql, Object...obj) &#123;</span><br><span class="line">		Connection con = getConnection();</span><br><span class="line">		ResultSet rs = null;</span><br><span class="line">		PreparedStatement ps = null;</span><br><span class="line">		try &#123;</span><br><span class="line">			ps = con.prepareStatement(sql);</span><br><span class="line">			<span class="keyword">for</span> (int i = 0; i &lt; obj.length; i++) &#123;</span><br><span class="line">				ps.setObject(i + 1, obj[i]);</span><br><span class="line">			&#125;</span><br><span class="line">			rs = ps.executeQuery();</span><br><span class="line">			List&lt;Map&lt;String, Object&gt;&gt; list = new ArrayList&lt;&gt;();</span><br><span class="line">			int count = rs.getMetaData().getColumnCount();</span><br><span class="line">			<span class="keyword">while</span> (rs.next()) &#123;</span><br><span class="line">				Map&lt;String, Object&gt; map = new HashMap&lt;String,Object&gt;();</span><br><span class="line">				<span class="keyword">for</span> (int i = 0; i &lt; count; i++) &#123;</span><br><span class="line">					Object ob = rs.getObject(i + 1);</span><br><span class="line">					String key = rs.getMetaData().getColumnName(i + 1);</span><br><span class="line">				map.put(key, ob);</span><br><span class="line">				 &#125;</span><br><span class="line">				list.add(map);</span><br><span class="line">		 	&#125;</span><br><span class="line">			<span class="built_in">return</span> list;</span><br><span class="line">		 &#125; catch (SQLException e) &#123;</span><br><span class="line">			// TODO Auto-generated catch block</span><br><span class="line">			e.printStackTrace();</span><br><span class="line">		 &#125; finally &#123;</span><br><span class="line">			close(rs, ps, con);</span><br><span class="line">		 &#125;</span><br><span class="line">			<span class="built_in">return</span> null;</span><br><span class="line">		 &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>测试<br>1）可先启动⼀个进程，然后再启动⼀个进程（两个进程模拟分布式环境下，通⼀个定时任务部署了两份在⼯作）<br>2）两个进程逐个启动，观察现象<br>3）关闭其中执⾏的进程，观察现象</p>
</li>
<li><p>Leader节点选举机制<br>每个Elastic-Job的任务执⾏实例App作为Zookeeper的客户端来操作ZooKeeper的znode<br>（1）多个实例同时创建/leader节点<br>（2）/leader节点只能创建⼀个，后创建的会失败，创建成功的实例会被选为leader节点，执⾏任务</p>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<h5 id="Elastic-Job-Lite轻量级去中⼼化的特点"><a href="#Elastic-Job-Lite轻量级去中⼼化的特点" class="headerlink" title="Elastic-Job-Lite轻量级去中⼼化的特点"></a>Elastic-Job-Lite轻量级去中⼼化的特点</h5><p>如何理解轻量级和去中⼼化？</p>
<p><img src="/images/dcs/dcs24.png" srcset="/img/loading.gif" alt="dcs"></p>
<h5 id="任务分⽚"><a href="#任务分⽚" class="headerlink" title="任务分⽚"></a>任务分⽚</h5><p>⼀个⼤的⾮常耗时的作业Job，⽐如：⼀次要处理⼀亿的数据，那这⼀亿的数据存储在数据库中，如果⽤⼀个作业节点处理⼀亿数据要很久，在互联⽹领域是不太能接受的，互联⽹领域更希望机器的增加去横向扩展处理能⼒。所以，ElasticJob可以把作业分为多个的task（每⼀个task就是⼀个任务分⽚），每⼀个task交给具体的⼀个机器实例去处理（⼀个机器实例是可以处理多个task的），但是具体每个task执⾏什么逻辑由我们⾃⼰来指定。</p>
<p><img src="/images/dcs/dcs25.png" srcset="/img/loading.gif" alt="dcs"></p>
<p>Strategy策略定义这些分⽚项怎么去分配到各个机器上去，默认是平均去分，可以定制，⽐如某⼀个机器负载 ⽐较⾼或者预配置⽐较⾼，那么就可以写策略。分⽚和作业本身是通过⼀个注册中⼼协调的，因为在分布式环境下，状态数据肯定集中到⼀点，才可以在分布式中沟通。</p>
<p><strong>分⽚代码</strong></p>
<p><img src="/images/dcs/dcs26.png" srcset="/img/loading.gif" alt="dcs"><br><img src="/images/dcs/dcs27.png" srcset="/img/loading.gif" alt="dcs"></p>
<h5 id="弹性扩容"><a href="#弹性扩容" class="headerlink" title="弹性扩容"></a>弹性扩容</h5><p><img src="/images/dcs/dcs28.png" srcset="/img/loading.gif" alt="dcs"></p>
<p>新增加⼀个运⾏实例app3，它会⾃动注册到注册中⼼，注册中⼼发现新的服务上线，注册中⼼会通知ElasticJob 进⾏重新分⽚，那么总得分⽚项有多少，那么就可以搞多少个实例机器，⽐如完全可以分1000⽚<br>最多就可以有多少app实例，机器能撑得住，完全可以分1000⽚<br>那么就可以搞1000台机器⼀起执⾏作业<br>注意：</p>
<ol>
<li>分⽚项也是⼀个JOB配置，修改配置，重新分⽚，在<strong>下⼀次定时运⾏之前会重新调⽤分⽚算法</strong>，那么<br>这个分⽚算法的结果就是：哪台机器运⾏哪⼀个⼀⽚，这个结果存储到zk中的，主节点会把分⽚给分好，放到注册中⼼去，然后执⾏节点从注册中⼼获取信息(执⾏节点在定时任务开启的时候获取相应的分⽚)。 </li>
<li>如果所有的节点挂掉值剩下⼀个节点，所有分⽚都会指向剩下的⼀个节点，这也是ElasticJob的⾼可⽤。</li>
</ol>

            <hr>
          </div>
          <br>
          <div>
            <p>
            
              <span>
                <i class="iconfont icon-inbox"></i>
                
                  <a class="hover-with-bg" href="/categories/%E5%88%86%E5%B8%83%E5%BC%8F%E6%9E%B6%E6%9E%84">分布式架构</a>
                  &nbsp;
                
              </span>&nbsp;&nbsp;
            
            
              <span>
                <i class="iconfont icon-tag"></i>
                
                  <a class="hover-with-bg" href="/tags/Hash%E7%AE%97%E6%B3%95">Hash算法</a>
                
                  <a class="hover-with-bg" href="/tags/%E5%88%86%E5%B8%83%E5%BC%8F">分布式</a>
                
              </span>
            
            </p>
            
              <p class="note note-warning">本博客所有文章除特别声明外，均采用 <a href="https://zh.wikipedia.org/wiki/Wikipedia:CC_BY-SA_3.0%E5%8D%8F%E8%AE%AE%E6%96%87%E6%9C%AC" target="_blank" rel="nofollow noopener noopener">CC BY-SA 3.0协议</a> 。转载请注明出处！</p>
            
          </div>
        </div>
      </div>
    </div>
    <div class="d-none d-lg-block col-lg-2 toc-container">
      
  <div id="toc">
    <p class="h5"><i class="far fa-list-alt"></i>&nbsp;目录</p>
    <div id="tocbot"></div>
  </div>

    </div>
  </div>
</div>

<!-- custom -->


<!-- Comments -->
<div class="col-lg-7 mx-auto nopadding-md">
  <div class="container comments mx-auto" id="comments">
    
      <br><br>
      
      

    
  </div>
</div>

    
  </main>

  
    <a class="z-depth-1" id="scroll-top-button" href="#" role="button">
      <i class="fa fa-chevron-up scroll-top-arrow" aria-hidden="true"></i>
    </a>
  

  
    <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v"
                 for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>
  

  <footer class="mt-5">
  <div class="text-center py-3">
    <a href="https://github.com/Loonycoder" target="_blank" rel="nofollow noopener"><b>望月</b></a>
    <i class="iconfont icon-love"></i>
    <a href="https://github.com/Loonycoder" target="_blank" rel="nofollow noopener"> <b>LoonyCoder</b></a>
    <br>

    
  
    <!-- 不蒜子统计PV -->
    
    &nbsp;<span id="busuanzi_container_site_pv"></span>访问量: 
          <span id="busuanzi_value_site_pv"></span> &nbsp;
  
  
    <!-- 不蒜子统计UV -->
    
    &nbsp;<span id="busuanzi_container_site_uv"></span>访客数: 
            <span id="busuanzi_value_site_uv"></span> &nbsp;
  
  <br>



    
  <!-- 备案信息 -->
  <a href="http://beian.miit.gov.cn/" target="_blank"
     rel="nofollow noopener">京ICP证20008174号</a>
  
    <a
      href="http://www.beian.gov.cn/portal/registerSystemInfo?recordcode=20008174"
      rel="nofollow noopener"
      class="police-beian"
      target="_blank"
    >
      <span class="police-beian-sep">&nbsp;|&nbsp;</span>
      
        <img src="/img/police_beian.png" />
      
      <span>京公网安备20008174号</span>
    </a>
  



    <!-- cnzz Analytics icon -->
    

  </div>
</footer>

<!-- SCRIPTS -->
<script src="/lib/jquery/jquery.min.js" ></script>
<script src="/lib/popper/popper.min.js" ></script>
<script src="/lib/bootstrap/js/bootstrap.min.js" ></script>
<script src="/lib/mdbootstrap/js/mdb.min.js" ></script>
<script src="/js/main.js" ></script>


  <script src="/js/lazyload.js" ></script>



  <script src="/js/post.js" ></script>
  
    <script src="/lib/tocbot/tocbot.min.js" ></script>
    <script>
      $(document).ready(function () {
        tocbot.init({
          tocSelector: '#tocbot',
          contentSelector: '.post-content',
          headingSelector: 'h1,h2,h3,h4,h5,h6',
          linkClass: 'tocbot-link',
          activeLinkClass: 'tocbot-active-link',
          listClass: 'tocbot-list',
          isCollapsedClass: 'tocbot-is-collapsed',
          collapsibleClass: 'tocbot-is-collapsible',
          scrollSmooth: true,
        });
      });
    </script>
  



  <script src="/lib/smoothscroll/SmoothScroll.min.js" ></script>



  <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" ></script>


<!-- Plugins -->


  

  

  

  

  <!-- cnzz Analytics -->
  



  <script src="/lib/prettify/prettify.min.js" ></script>
  <script>
    $(document).ready(function () {
      $('pre').addClass('prettyprint  linenums');
      prettyPrint();
    })
  </script>



  <script src="/lib/typed/typed.min.js" ></script>
  <script>
    var typed = new Typed('#subtitle', {
      strings: [
        '  ',
        "分布式集群架构场景化解决方案——分布式调度问题&nbsp;",
      ],
      cursorChar: "_",
      typeSpeed: 70,
      loop: false,
    });
    typed.stop();
    $(document).ready(function () {
      $(".typed-cursor").addClass("h2");
      typed.start();
    });
  </script>



  <script src="/lib/anchor/anchor.min.js" ></script>
  <script>
    anchors.options = {
      placement: "right",
      visible: "hover",
      
      icon: "❡"
      
    };
    var el = "h1,h2,h3,h4,h5,h6".split(",");
    var res = [];
    for (item of el) {
      res.push(".markdown-body > " + item)
    }
    anchors.add(res.join(", "))
  </script>



  <script src="/js/local-search.js" ></script>
  <script>
    var path = "/local-search.xml";
    var inputArea = document.querySelector("#local-search-input");
    inputArea.onclick = function () {
      getSearchFile(path);
      this.onclick = null
    }
  </script>



  <script src="/lib/fancybox/jquery.fancybox.min.js" ></script>
  <script>
    $("#post img:not(.no-zoom img, img[no-zoom])").each(
      function () {
        var element = document.createElement("a");
        $(element).attr("data-fancybox", "images");
        $(element).attr("href", $(this).attr("src"));
        $(this).wrap(element);
      }
    );
  </script>





  
  
    <script>
      !function (e, t, a) {
        function r() {
          for (var e = 0; e < s.length; e++) s[e].alpha <= 0 ? (t.body.removeChild(s[e].el), s.splice(e, 1)) : (s[e].y--, s[e].scale += .004, s[e].alpha -= .013, s[e].el.style.cssText = "left:" + s[e].x + "px;top:" + s[e].y + "px;opacity:" + s[e].alpha + ";transform:scale(" + s[e].scale + "," + s[e].scale + ") rotate(45deg);background:" + s[e].color + ";z-index:99999");
          requestAnimationFrame(r)
        }

        function n() {
          var t = "function" == typeof e.onclick && e.onclick;
          e.onclick = function (e) {
            t && t(), o(e)
          }
        }

        function o(e) {
          var a = t.createElement("div");
          a.className = "heart", s.push({
            el: a,
            x: e.clientX - 5,
            y: e.clientY - 5,
            scale: 1,
            alpha: 1,
            color: c()
          }), t.body.appendChild(a)
        }

        function i(e) {
          var a = t.createElement("style");
          a.type = "text/css";
          try {
            a.appendChild(t.createTextNode(e))
          } catch (t) {
            a.styleSheet.cssText = e
          }
          t.getElementsByTagName("head")[0].appendChild(a)
        }

        function c() {
          return "rgb(" + ~~(255 * Math.random()) + "," + ~~(255 * Math.random()) + "," + ~~(255 * Math.random()) + ")"
        }

        var s = [];
        e.requestAnimationFrame = e.requestAnimationFrame || e.webkitRequestAnimationFrame || e.mozRequestAnimationFrame || e.oRequestAnimationFrame || e.msRequestAnimationFrame || function (e) {
          setTimeout(e, 1e3 / 60)
        }, i(".heart{width: 10px;height: 10px;position: fixed;background: #f00;transform: rotate(45deg);-webkit-transform: rotate(45deg);-moz-transform: rotate(45deg);}.heart:after,.heart:before{content: '';width: inherit;height: inherit;background: inherit;border-radius: 50%;-webkit-border-radius: 50%;-moz-border-radius: 50%;position: fixed;}.heart:after{top: -5px;}.heart:before{left: -5px;}"), n(), r()
      }(window, document);
    </script>
  








</body>
</html>
