---
title: 分布式集群架构场景化解决方案——集群时钟同步问题
categories:
    - 分布式架构
    
date: 2019-10-10 18:10:14
tags:
  - Hash算法
  - 分布式


---

### 时钟不同步导致的问题

时钟此处指服务器时间，如果集群中各个服务器时钟不⼀致势必导致⼀系列问题，试想 “集群是各个服务器⼀起团队化作战，⼤家⼯作都不在⼀个点上，岂不乱了套！”

举⼀个例⼦，电商⽹站业务中，新增⼀条订单，那么势必会在订单表中增加了⼀条记录，该条记录中应该会有“下单时间”这样的字段，往往我们会在程序中获取当前系统时间插⼊到数据库或者直接从数据库服务器获取时间。那我们的订单⼦系统是集群化部署，或者我们的数据库也是分库分表的集群化部署，然⽽他们的系统时钟缺不⼀致，⽐如有⼀台服务器的时间是昨天，那么这个时候下单时间就成了昨天，那我们的数据将会混乱！如下：

![dcs](/images/dcs/dcs14.png)

---

### 集群时钟同步配置

- 集群时钟同步思路
	- 分布式集群中各个服务器节点都可以连接互联⽹
	思路：
	![dcs](/images/dcs/dcs15.png)
	操作⽅式：
	```bash
	#使⽤ ntpdate ⽹络时间同步命令
	ntpdate -u ntp.api.bz #从⼀个时间服务器同步时间
	```
	windows有计划任务
	Linux也有定时任务，crond，可以使⽤linux的定时任务，每隔10分钟执⾏⼀次ntpdate命令。

	- 分布式集群中某⼀个服务器节点可以访问互联⽹或者所有节点都不能够访问互联⽹
	思路：
	![dcs](/images/dcs/dcs16.png)
	操作⽅式：
	1. 选取集群中的⼀个服务器节点A(172.17.0.17)作为时间服务器（整个集群时间从这台服务器同步，如果这台服务器能够访问互联⽹，可以让这台服务器和⽹络时间保持同步，如果不能就⼿动设置⼀个时间）
		- ⾸先设置好A的时间
		- 把A配置为时间服务器（修改/etc/ntp.conf⽂件）
		```bash
		1、如果有 restrict default ignore，注释掉它
		2、添加如下⼏⾏内容
		 restrict 172.17.0.0 mask 255.255.255.0 nomodify notrap # 放开局域⽹同步功能,172.17.0.0是你的局域⽹⽹段
		 server 127.127.1.0 # local clock
		 fudge 127.127.1.0 stratum 10
		3、重启⽣效并配置ntpd服务开机⾃启动
		 service ntpd restart
		 chkconfig ntpd on
		```
		- 集群中其他节点就可以从A服务器同步时间了
		```bash
		ntpdate 172.17.0.17
		```
